{% extends 'base.html' %}
{% load static %}
{% load product_filters %}

{% block title %}Détails du remboursement - {{ refund.uid }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 py-12">
    <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8 animate-fade-in">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full mb-4">
                    <i class="fas fa-undo text-3xl text-white"></i>
                </div>
                <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">Détails du remboursement</h1>
                <p class="text-gray-600 dark:text-gray-300">Suivi complet de votre demande</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Content -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Refund Information -->
                    <div class="card bg-white dark:bg-gray-800 shadow-2xl animate-slide-in">
                        <div class="card-body">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="card-title text-2xl">
                                    <i class="fas fa-info-circle text-primary mr-2"></i>
                                    Informations du remboursement
                                </h2>
                                <span class="badge badge-{% if refund.status == 'completed' %}success{% elif refund.status == 'pending' %}warning{% elif refund.status == 'processing' %}info{% elif refund.status == 'failed' %}error{% else %}neutral{% endif %} badge-lg">
                                    {{ refund.get_status_display }}
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                                        <span class="font-semibold">N° Remboursement:</span>
                                        <span class="font-mono text-sm">{{ refund.uid }}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                                        <span class="font-semibold">Montant:</span>
                                        <span class="font-bold text-success text-xl">{{ refund.amount|floatformat:0 }} FCFA</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                                        <span class="font-semibold">Raison:</span>
                                        <span class="font-medium">{{ refund.get_reason_display }}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                                        <span class="font-semibold">Méthode:</span>
                                        <span class="font-medium">{{ refund.get_refund_method_display }}</span>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                                        <span class="font-semibold">Date de demande:</span>
                                        <span>{{ refund.created_at|date:"d/m/Y H:i" }}</span>
                                    </div>
                                    
                                    {% if refund.processed_at %}
                                    <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                                        <span class="font-semibold">Traité le:</span>
                                        <span>{{ refund.processed_at|date:"d/m/Y H:i" }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if refund.completed_at %}
                                    <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                                        <span class="font-semibold">Terminé le:</span>
                                        <span>{{ refund.completed_at|date:"d/m/Y H:i" }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if refund.refund_transaction_id %}
                                    <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                                        <span class="font-semibold">ID Transaction:</span>
                                        <code class="text-xs">{{ refund.refund_transaction_id }}</code>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Information -->
                    <div class="card bg-white dark:bg-gray-800 shadow-2xl animate-slide-in">
                        <div class="card-body">
                            <h2 class="card-title text-2xl mb-6">
                                <i class="fas fa-shopping-cart text-primary mr-2"></i>
                                Commande associée
                            </h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                                        <span class="font-semibold">N° Commande:</span>
                                        <a href="{% url 'orders:order_detail' refund.order.uid %}" class="link link-primary font-mono text-sm">
                                            {{ refund.order.uid }}
                                        </a>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                                        <span class="font-semibold">Date de commande:</span>
                                        <span>{{ refund.order.created_at|date:"d/m/Y H:i" }}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                                        <span class="font-semibold">Statut:</span>
                                        <span class="badge badge-{{ refund.order.status|yesno:'success,warning' }}">
                                            {{ refund.order.get_status_display }}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                                        <span class="font-semibold">Montant total:</span>
                                        <span class="font-bold">{{ refund.order.total_amount|floatformat:0 }} FCFA</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                                        <span class="font-semibold">Méthode de paiement:</span>
                                        <span class="font-medium">{{ refund.order.get_payment_method_display }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reason Description -->
                    {% if refund.reason_description %}
                    <div class="card bg-white dark:bg-gray-800 shadow-2xl animate-slide-in">
                        <div class="card-body">
                            <h2 class="card-title text-2xl mb-6">
                                <i class="fas fa-comment text-primary mr-2"></i>
                                Description de la raison
                            </h2>
                            
                            <div class="alert alert-info">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-info-circle text-2xl text-blue-500 mt-1"></i>
                                    <div>
                                        <p class="whitespace-pre-line">{{ refund.reason_description }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Order Items -->
                    <div class="card bg-white dark:bg-gray-800 shadow-2xl animate-slide-in">
                        <div class="card-body">
                            <h2 class="card-title text-2xl mb-6">
                                <i class="fas fa-box text-primary mr-2"></i>
                                Articles concernés
                            </h2>
                            
                            <div class="overflow-x-auto">
                                <table class="table table-zebra w-full">
                                    <thead>
                                        <tr>
                                            <th>Produit</th>
                                            <th class="text-center">Quantité</th>
                                            <th class="text-end">Prix unitaire</th>
                                            <th class="text-end">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in refund.order.items.all %}
                                        <tr>
                                            <td>
                                                <div class="flex items-center gap-3">
                                                    {% if item.product.image %}
                                                    <div class="avatar">
                                                        <div class="w-12 h-12 rounded">
                                                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    <div>
                                                        <div class="font-bold">{{ item.product.name }}</div>
                                                        <div class="text-sm text-base-content/70">{{ item.product.category.name }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge badge-primary">{{ item.quantity }}</span>
                                            </td>
                                            <td class="text-end">
                                                <span class="font-semibold">{{ item.price_at_time|floatformat:0 }} FCFA</span>
                                            </td>
                                            <td class="text-end">
                                                <span class="font-bold">{{ item.price_at_time|floatformat:0|mul:item.quantity }} FCFA</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Status and Actions -->
                    <div class="card bg-white dark:bg-gray-800 shadow-2xl animate-slide-in">
                        <div class="card-body">
                            <h2 class="card-title text-xl mb-6">
                                <i class="fas fa-cogs text-primary mr-2"></i>
                                Statut et actions
                            </h2>
                            
                            <!-- Status Alert -->
                            {% if refund.status == 'pending' %}
                                <div class="alert alert-warning">
                                    <div class="flex items-start gap-3">
                                        <i class="fas fa-clock text-2xl text-yellow-500 mt-1"></i>
                                        <div>
                                            <h3 class="font-bold">En attente de traitement</h3>
                                            <p class="text-sm">Votre demande de remboursement est en cours d'examen. Vous serez contacté sous 24-48 heures.</p>
                                        </div>
                                    </div>
                                </div>
                            {% elif refund.status == 'processing' %}
                                <div class="alert alert-info">
                                    <div class="flex items-start gap-3">
                                        <i class="fas fa-cog fa-spin text-2xl text-blue-500 mt-1"></i>
                                        <div>
                                            <h3 class="font-bold">En cours de traitement</h3>
                                            <p class="text-sm">Votre remboursement est en cours de traitement. Vous serez notifié dès qu'il sera effectué.</p>
                                        </div>
                                    </div>
                                </div>
                            {% elif refund.status == 'completed' %}
                                <div class="alert alert-success">
                                    <div class="flex items-start gap-3">
                                        <i class="fas fa-check-circle text-2xl text-green-500 mt-1"></i>
                                        <div>
                                            <h3 class="font-bold">Remboursement terminé</h3>
                                            <p class="text-sm">Votre remboursement a été effectué avec succès. Le montant devrait apparaître sur votre compte sous 2-5 jours ouvrés.</p>
                                        </div>
                                    </div>
                                </div>
                            {% elif refund.status == 'failed' %}
                                <div class="alert alert-error">
                                    <div class="flex items-start gap-3">
                                        <i class="fas fa-times-circle text-2xl text-red-500 mt-1"></i>
                                        <div>
                                            <h3 class="font-bold">Échec du remboursement</h3>
                                            <p class="text-sm">Le remboursement a échoué. Veuillez nous contacter pour plus d'informations.</p>
                                        </div>
                                    </div>
                                </div>
                            {% elif refund.status == 'cancelled' %}
                                <div class="alert alert-neutral">
                                    <div class="flex items-start gap-3">
                                        <i class="fas fa-ban text-2xl text-gray-500 mt-1"></i>
                                        <div>
                                            <h3 class="font-bold">Remboursement annulé</h3>
                                            <p class="text-sm">Ce remboursement a été annulé.</p>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Action Buttons -->
                            <div class="space-y-3 pt-4">
                                <a href="{% url 'orders:order_detail' refund.order.uid %}" class="btn btn-outline btn-primary w-full hover-scale transition-all">
                                    <i class="fas fa-eye mr-2"></i>
                                    Voir la commande
                                </a>
                                
                                <a href="{% url 'orders:refund_list' %}" class="btn btn-outline btn-secondary w-full hover-scale transition-all">
                                    <i class="fas fa-list mr-2"></i>
                                    Mes remboursements
                                </a>
                                
                                {% if refund.status == 'completed' %}
                                <a href="{% url 'orders:order_receipt_pdf' refund.order.uid %}" class="btn btn-outline btn-success w-full hover-scale transition-all" target="_blank">
                                    <i class="fas fa-file-pdf mr-2"></i>
                                    Télécharger le reçu
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Timeline -->
                    <div class="card bg-white dark:bg-gray-800 shadow-xl animate-slide-in">
                        <div class="card-body">
                            <h2 class="card-title text-xl mb-6">
                                <i class="fas fa-timeline text-primary mr-2"></i>
                                Timeline
                            </h2>
                            
                            <div class="steps steps-vertical">
                                <div class="step step-primary">
                                    <div class="step-content">
                                        <div class="font-semibold">Demande créée</div>
                                        <div class="text-sm text-gray-500">{{ refund.created_at|date:"d/m/Y H:i" }}</div>
                                    </div>
                                </div>
                                
                                {% if refund.processed_at %}
                                <div class="step step-primary">
                                    <div class="step-content">
                                        <div class="font-semibold">En traitement</div>
                                        <div class="text-sm text-gray-500">{{ refund.processed_at|date:"d/m/Y H:i" }}</div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if refund.completed_at %}
                                <div class="step step-primary">
                                    <div class="step-content">
                                        <div class="font-semibold">Terminé</div>
                                        <div class="text-sm text-gray-500">{{ refund.completed_at|date:"d/m/Y H:i" }}</div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add ripple effect to buttons
    document.querySelectorAll('.btn').forEach(button => {
        button.addEventListener('click', function(e) {
            createRipple(e, this);
        });
    });

    // Animate timeline steps
    const steps = document.querySelectorAll('.step');
    steps.forEach((step, index) => {
        setTimeout(() => {
            step.classList.add('animate-fade-in');
        }, index * 200);
    });
});
</script>
{% endblock %}