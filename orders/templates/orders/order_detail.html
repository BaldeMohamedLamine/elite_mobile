{% extends 'base.html' %}
{% load static %}
{% load product_filters %}

{% block title %}Détails de la commande #{{ order.order_number|default:order.uid|truncatechars:8 }} - Boutique{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-primary/5 via-base-100 to-secondary/5 py-8">
    <div class="container mx-auto px-4">
        <!-- Breadcrumb -->
        <div class="breadcrumbs text-sm mb-6 animate-fade-in">
            <ul>
                <li><a href="{% url 'products:home' %}" class="link link-hover">Accueil</a></li>
                <li><a href="{% url 'orders:order_list' %}" class="link link-hover">Mes commandes</a></li>
                <li>Commande #{{ order.order_number|default:order.uid|truncatechars:8 }}</li>
            </ul>
        </div>

        <!-- Header -->
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8 animate-slide-in">
            <div>
                <h1 class="text-4xl font-bold gradient-text mb-2">
                    <i class="fas fa-receipt text-primary mr-3"></i>
                    Commande #{{ order.order_number|default:order.uid|truncatechars:8 }}
                </h1>
                <p class="text-base-content/70">
                    <i class="fas fa-calendar mr-2"></i>
                    Passée le {{ order.created_at|date:"d/m/Y à H:i" }}
                </p>
            </div>
            
            <!-- Status Badge -->
            <div class="badge badge-{% if order.status == 'pending' %}warning{% elif order.status == 'paid' %}info{% elif order.status == 'shipped' %}primary{% elif order.status == 'delivered' %}success{% elif order.status == 'cancelled' %}error{% endif %} badge-lg mt-4 lg:mt-0">
                {{ order.get_status_display }}
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
            <div class="max-w-6xl mx-auto mb-6">
                <div class="space-y-2">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags|default:'info' }} animate-slide-in" role="alert">
                            <i class="fas fa-info-circle"></i>
                            <span>{{ message }}</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Order Information -->
                <div class="card bg-base-100 shadow-xl animate-slide-in">
                    <div class="card-body">
                        <h2 class="card-title text-2xl mb-6">
                            <i class="fas fa-info-circle text-primary"></i>
                            Informations de la commande
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- General Info -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-base-content/80 mb-3">
                                    <i class="fas fa-clipboard-list text-secondary mr-2"></i>
                                    Informations générales
                                </h3>
                                
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-base-content/70">Date de commande</span>
                                        <span class="font-medium">{{ order.created_at|date:"d/m/Y à H:i" }}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center">
                                        <span class="text-base-content/70">Statut</span>
                                        <span class="badge badge-{% if order.status == 'pending' %}warning{% elif order.status == 'paid' %}info{% elif order.status == 'shipped' %}primary{% elif order.status == 'delivered' %}success{% elif order.status == 'cancelled' %}error{% endif %}">
                                            {{ order.get_status_display }}
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center">
                                        <span class="text-base-content/70">Méthode de paiement</span>
                                        <span class="font-medium">
                                            {% if order.payment_method == 'orange_money' %}
                                                <i class="fas fa-mobile-alt text-warning mr-1"></i>Orange Money
                                            {% elif order.payment_method == 'visa_mastercard' %}
                                                <i class="fas fa-credit-card text-primary mr-1"></i>Carte bancaire
                                            {% else %}
                                                <i class="fas fa-money-bill-wave text-success mr-1"></i>À la livraison
                                            {% endif %}
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center">
                                        <span class="text-base-content/70">Statut du paiement</span>
                                        <span class="badge badge-{% if order.payment_status == 'paid' %}success{% elif order.payment_status == 'pending' %}warning{% else %}error{% endif %}">
                                            {{ order.get_payment_status_display }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Delivery Info -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-base-content/80 mb-3">
                                    <i class="fas fa-truck text-accent mr-2"></i>
                                    Informations de livraison
                                </h3>
                                
                                <div class="space-y-3">
                                    <div>
                                        <span class="text-base-content/70 block mb-1">Adresse</span>
                                        <span class="font-medium">{{ order.delivery_address }}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center">
                                        <span class="text-base-content/70">Téléphone</span>
                                        <span class="font-medium">{{ order.delivery_phone }}</span>
                                    </div>
                                    
                                    {% if order.delivery_notes %}
                                    <div>
                                        <span class="text-base-content/70 block mb-1">Notes</span>
                                        <span class="font-medium">{{ order.delivery_notes }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="card bg-base-100 shadow-xl animate-slide-in">
                    <div class="card-body">
                        <h2 class="card-title text-2xl mb-6">
                            <i class="fas fa-shopping-cart text-primary"></i>
                            Articles commandés
                        </h2>

                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full">
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>Prix unitaire</th>
                                        <th>Quantité</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in order.items.all %}
                                    <tr class="hover">
                                        <td>
                                            <div class="flex items-center space-x-3">
                                                <div class="avatar placeholder">
                                                    <div class="bg-neutral text-neutral-content rounded w-12">
                                                        <i class="fas fa-box"></i>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="font-bold">{{ item.product.name }}</div>
                                                    <div class="text-sm opacity-50">{{ item.product.category.name }}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="font-medium">{{ item.price_at_time|floatformat:0 }} FCFA</td>
                                        <td>
                                            <span class="badge badge-outline">{{ item.quantity }}</span>
                                        </td>
                                        <td class="font-bold text-primary">{{ item.price_at_time|floatformat:0|mul:item.quantity }} FCFA</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="3">Sous-total</th>
                                        <th class="text-lg">{{ order.subtotal|floatformat:0 }} FCFA</th>
                                    </tr>
                                    <tr>
                                        <th colspan="3">Frais de livraison</th>
                                        <th class="text-lg">{{ order.delivery_fee|floatformat:0 }} FCFA</th>
                                    </tr>
                                    <tr class="bg-primary/10">
                                        <th colspan="3" class="text-lg">Total</th>
                                        <th class="text-xl text-primary font-bold">{{ order.total_amount|floatformat:0 }} FCFA</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Actions -->
                <div class="card bg-base-100 shadow-xl animate-slide-in">
                    <div class="card-body">
                        <h3 class="card-title text-xl mb-4">
                            <i class="fas fa-cogs text-primary"></i>
                            Actions
                        </h3>
                        
                        <div class="space-y-3">
                            {% if order.payment_status == 'pending' and order.payment_method != 'cash_on_delivery' %}
                            <a href="{% url 'orders:payment_process' order.uid %}" class="btn btn-primary w-full hover-glow transition-all">
                                <i class="fas fa-credit-card mr-2"></i>
                                Finaliser le paiement
                            </a>
                            {% endif %}
                            
                            <!-- PDF Downloads -->
                            <a href="{% url 'orders:order_invoice_pdf' order.uid %}" class="btn btn-info w-full hover-scale transition-all" target="_blank">
                                <i class="fas fa-file-pdf mr-2"></i>
                                Télécharger la facture
                            </a>
                            
                            {% if order.is_paid %}
                            <a href="{% url 'orders:order_receipt_pdf' order.uid %}" class="btn btn-success w-full hover-scale transition-all" target="_blank">
                                <i class="fas fa-receipt mr-2"></i>
                                Télécharger le reçu
                            </a>
                            {% endif %}
                            
                            {% if order.can_be_cancelled %}
                            <button class="btn btn-error w-full hover-scale transition-all" onclick="cancelOrder()">
                                <i class="fas fa-times mr-2"></i>
                                Annuler la commande
                            </button>
                            {% endif %}
                            
                            {% if order.is_paid and order.status != 'cancelled' %}
                            <a href="{% url 'orders:refund_request' order.uid %}" class="btn btn-warning w-full hover-scale transition-all">
                                <i class="fas fa-undo mr-2"></i>
                                Demander un remboursement
                            </a>
                            {% endif %}
                            
                            <a href="{% url 'orders:order_list' %}" class="btn btn-outline btn-secondary w-full hover-scale transition-all">
                                <i class="fas fa-list mr-2"></i>
                                Retour aux commandes
                            </a>
                        </div>

                        <!-- Admin Actions -->
                        {% if user.is_staff %}
                        <div class="divider">Actions administrateur</div>
                        <form method="post" action="{% url 'orders:order_status_update' order.uid %}" class="space-y-3">
                            {% csrf_token %}
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Changer le statut</span>
                                </label>
                                <select name="status" class="select select-bordered w-full">
                                    <option value="">Sélectionner un statut</option>
                                    <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>En attente</option>
                                    <option value="paid" {% if order.status == 'paid' %}selected{% endif %}>Payée</option>
                                    <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>En cours de traitement</option>
                                    <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>Expédiée</option>
                                    <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Livrée</option>
                                    <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Annulée</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-warning w-full hover-scale transition-all">
                                <i class="fas fa-save mr-2"></i>
                                Mettre à jour
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>

                <!-- Payment Information -->
                {% if order.payments.exists %}
                <div class="card bg-base-100 shadow-xl animate-slide-in">
                    <div class="card-body">
                        <h3 class="card-title text-xl mb-4">
                            <i class="fas fa-credit-card text-primary"></i>
                            Paiements
                        </h3>
                        
                        <div class="space-y-4">
                            {% for payment in order.payments.all %}
                            <div class="border border-base-300 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-medium">{{ payment.get_method_display }}</span>
                                    <span class="badge badge-{% if payment.status == 'completed' %}success{% elif payment.status == 'pending' %}warning{% else %}error{% endif %}">
                                        {{ payment.get_status_display }}
                                    </span>
                                </div>
                                <div class="text-sm text-base-content/70">
                                    <div>Montant: {{ payment.amount|floatformat:0 }} FCFA</div>
                                    {% if payment.orange_money_phone %}
                                    <div>Téléphone: {{ payment.orange_money_phone }}</div>
                                    {% endif %}
                                    {% if payment.card_last_four %}
                                    <div>Carte: **** **** **** {{ payment.card_last_four }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Order Timeline -->
                <div class="card bg-base-100 shadow-xl animate-slide-in">
                    <div class="card-body">
                        <h3 class="card-title text-xl mb-4">
                            <i class="fas fa-history text-primary"></i>
                            Historique
                        </h3>
                        
                        <div class="timeline">
                            <div class="timeline-item {% if order.status != 'pending' %}completed{% endif %}">
                                <div class="timeline-marker">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="font-medium">Commande créée</div>
                                    <div class="text-sm text-base-content/70">{{ order.created_at|date:"d/m/Y H:i" }}</div>
                                </div>
                            </div>
                            
                            {% if order.paid_at %}
                            <div class="timeline-item {% if order.status in 'paid,processing,shipped,delivered' %}completed{% endif %}">
                                <div class="timeline-marker">
                                    <i class="fas fa-credit-card"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="font-medium">Paiement confirmé</div>
                                    <div class="text-sm text-base-content/70">{{ order.paid_at|date:"d/m/Y H:i" }}</div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if order.status in 'shipped,delivered' %}
                            <div class="timeline-item {% if order.status == 'delivered' %}completed{% endif %}">
                                <div class="timeline-marker">
                                    <i class="fas fa-truck"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="font-medium">Commande expédiée</div>
                                    <div class="text-sm text-base-content/70">En cours de livraison</div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if order.delivered_at %}
                            <div class="timeline-item completed">
                                <div class="timeline-marker">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="font-medium">Commande livrée</div>
                                    <div class="text-sm text-base-content/70">{{ order.delivered_at|date:"d/m/Y H:i" }}</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div id="cancel-order-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">
            <i class="fas fa-exclamation-triangle text-warning mr-2"></i>
            Annuler la commande
        </h3>
        
        <p class="mb-4">Êtes-vous sûr de vouloir annuler cette commande ? Cette action est irréversible.</p>
        
        <div class="modal-action">
            <button class="btn btn-ghost" onclick="closeCancelModal()">Annuler</button>
            <button class="btn btn-error" id="confirm-cancel-btn">
                <i class="fas fa-times mr-2"></i>
                Confirmer l'annulation
            </button>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: flex-start;
}

.timeline-marker {
    position: absolute;
    left: -2rem;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    color: #6b7280;
    z-index: 1;
}

.timeline-item.completed .timeline-marker {
    background: #10b981;
    color: white;
}

.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: -1.5rem;
    top: 2rem;
    width: 2px;
    height: 1.5rem;
    background: #e5e7eb;
}

.timeline-content {
    flex: 1;
}
</style>

<script>
function cancelOrder() {
    document.getElementById('cancel-order-modal').classList.add('modal-open');
}

function closeCancelModal() {
    document.getElementById('cancel-order-modal').classList.remove('modal-open');
}

// Confirm cancellation
document.getElementById('confirm-cancel-btn').addEventListener('click', function() {
    // Add loading state
    this.innerHTML = '<span class="loading loading-spinner loading-sm mr-2"></span>Annulation...';
    this.disabled = true;
    
    // TODO: Implement order cancellation API call
    // For now, show a message
    setTimeout(() => {
        alert('Fonctionnalité d\'annulation en cours de développement');
        closeCancelModal();
        this.innerHTML = '<i class="fas fa-times mr-2"></i>Confirmer l\'annulation';
        this.disabled = false;
    }, 2000);
});

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('modal-open');
    }
});

// Add ripple effect to buttons
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.btn').forEach(button => {
        button.addEventListener('click', function(e) {
            createRipple(e, this);
        });
    });
});
</script>
{% endblock %}