{% extends 'base.html' %}
{% load static %}

{% block title %}Produits - Boutique E-commerce{% endblock %}
{% block description %}Découvrez notre sélection de produits de qualité avec des prix compétitifs{% endblock %}

{% block content %}
{% csrf_token %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
    <!-- Hero Section -->
    <section class="relative py-16 bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-700 overflow-hidden">
        <div class="absolute inset-0 bg-black opacity-20"></div>
        <div class="relative container mx-auto px-4">
            <div class="text-center text-white">
                <h1 class="text-5xl font-bold mb-4 animate-fade-in">
                    <i class="fas fa-shopping-bag mr-3"></i>
                    Nos Produits
                </h1>
                <p class="text-xl mb-8 opacity-90">Découvrez une sélection unique de produits de qualité</p>
                
                <!-- Search Bar -->
                <div class="max-w-2xl mx-auto">
                    <div class="relative">
                        <input type="text" 
                               placeholder="Rechercher un produit..." 
                               class="w-full px-6 py-4 text-lg rounded-2xl border-0 shadow-xl focus:ring-4 focus:ring-blue-300 focus:outline-none"
                               id="product-search">
                        <button class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl transition-all duration-300"
                                id="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Decorative elements -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
            <div class="absolute top-10 left-10 w-20 h-20 bg-white opacity-10 rounded-full animate-pulse"></div>
            <div class="absolute top-20 right-20 w-16 h-16 bg-white opacity-10 rounded-full animate-pulse delay-1000"></div>
            <div class="absolute bottom-10 left-1/4 w-12 h-12 bg-white opacity-10 rounded-full animate-pulse delay-2000"></div>
        </div>
    </section>

    <!-- Filters Section -->
    <section class="py-8 bg-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex flex-wrap gap-4 justify-center items-center">
                <div class="form-control">
                    <select class="select select-bordered w-full max-w-xs focus:ring-2 focus:ring-blue-500" id="category-filter">
                        <option value="">Toutes les catégories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-control">
                    <select class="select select-bordered w-full max-w-xs focus:ring-2 focus:ring-blue-500" id="price-filter">
                        <option value="">Tous les prix</option>
                        <option value="0-50000">Moins de 50 000 GNF</option>
                        <option value="50000-100000">50 000 - 100 000 GNF</option>
                        <option value="100000-500000">100 000 - 500 000 GNF</option>
                        <option value="500000+">Plus de 500 000 GNF</option>
                    </select>
                </div>
                <div class="form-control">
                    <select class="select select-bordered w-full max-w-xs focus:ring-2 focus:ring-blue-500" id="sort-filter">
                        <option value="">Trier par</option>
                        <option value="name">Nom (A-Z)</option>
                        <option value="-name">Nom (Z-A)</option>
                        <option value="price">Prix (croissant)</option>
                        <option value="-price">Prix (décroissant)</option>
                        <option value="-created_at">Plus récent</option>
                    </select>
                </div>
                <button class="btn btn-outline" id="clear-filters">
                    <i class="fas fa-times mr-2"></i>
                    Effacer
                </button>
            </div>
        </div>
    </section>

    <!-- Products Grid -->
    <section class="py-12">
        <div class="container mx-auto px-4">
            <!-- Results header -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">
                        <span id="product-count">{{ products|length }}</span> produit{{ products|length|pluralize }}
                    </h2>
                    <p class="text-gray-600">Trouvez exactement ce que vous cherchez</p>
                </div>
                
                <!-- View toggle -->
                <div class="flex bg-gray-100 rounded-lg p-1">
                    <button class="px-4 py-2 rounded-md bg-white shadow-sm text-gray-700" id="grid-view">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button class="px-4 py-2 rounded-md text-gray-500" id="list-view">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>

            <!-- Products Grid -->
            <div id="products-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                {% for product in products %}
                <div class="product-card bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden group">
                    <!-- Product Image -->
                    <div class="relative overflow-hidden">
                        {% if product.image %}
                        <img src="{{ product.image.url }}" 
                             alt="{{ product.name }}" 
                             class="w-full h-64 object-cover group-hover:scale-110 transition-transform duration-500">
                        {% else %}
                        <div class="w-full h-64 bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center">
                            <i class="fas fa-image text-4xl text-gray-400"></i>
                        </div>
                        {% endif %}
                        
                        <!-- Stock Status Badge -->
                        <div class="absolute top-4 right-4">
                            {% if product.stock.current_quantity > 10 %}
                            <span class="badge badge-success">
                                <i class="fas fa-check-circle mr-1"></i>
                                En stock
                            </span>
                            {% elif product.stock.current_quantity > 0 %}
                            <span class="badge badge-warning">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                Stock faible
                            </span>
                            {% else %}
                            <span class="badge badge-error">
                                <i class="fas fa-times-circle mr-1"></i>
                                Rupture
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                            <div class="flex space-x-2">
                                <a href="{% url 'products:product_detail' product.id %}" 
                                   class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye mr-1"></i>
                                    Voir
                                </a>
                                <button class="btn btn-secondary btn-sm add-to-cart" 
                                        data-product-id="{{ product.id }}">
                                    <i class="fas fa-cart-plus mr-1"></i>
                                    Ajouter
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Info -->
                    <div class="p-6">
                        <div class="mb-2">
                            <span class="badge badge-outline">{{ product.category.name }}</span>
                        </div>
                        
                        <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2">
                            {{ product.name }}
                        </h3>
                        
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">
                            {{ product.description|truncatewords:15 }}
                        </p>
                        
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-2xl font-bold text-blue-600">
                                {{ product.price|floatformat:0 }} GNF
                            </div>
                            
                            <div class="text-sm text-gray-500">
                                <i class="fas fa-box mr-1"></i>
                                {{ product.stock.current_quantity }} unités
                            </div>
                        </div>
                        
                        <!-- Add to Cart Button (always visible) -->
                        <button class="btn btn-primary w-full add-to-cart" 
                                data-product-id="{{ product.id }}">
                            <i class="fas fa-cart-plus mr-2"></i>
                            Ajouter au panier
                        </button>
                        
                        <!-- Stock indicator -->
                        <div class="mt-4">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                {% if product.stock.current_quantity > 0 %}
                                <div class="bg-{% if product.stock.current_quantity > 10 %}green{% elif product.stock.current_quantity > 5 %}yellow{% else %}red{% endif %}-500 h-2 rounded-full" 
                                     style="width: {% widthratio product.stock.current_quantity product.stock.max_quantity 100 %}%"></div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full text-center py-16">
                    <div class="text-gray-400 mb-4">
                        <i class="fas fa-box-open text-6xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Aucun produit trouvé</h3>
                    <p class="text-gray-500">Essayez de modifier vos critères de recherche</p>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
            <div class="flex justify-center mt-12">
                <div class="btn-group">
                    {% if page_obj.has_previous %}
                    <a href="?page=1" class="btn btn-outline">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline">
                        <i class="fas fa-angle-left"></i>
                    </a>
                    {% endif %}
                    
                    <span class="btn btn-active">
                        Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
                    </span>
                    
                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline">
                        <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="btn btn-outline">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </section>
</div>

<!-- Login Modal -->
{% if not request.user.is_authenticated %}
<div id="login-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Connexion requise</h3>
        <p class="mb-4">Vous devez être connecté pour ajouter des produits au panier.</p>
        <div class="modal-action">
            <a href="{% url 'users:login' %}" class="btn btn-primary">
                <i class="fas fa-sign-in-alt mr-2"></i>
                Se connecter
            </a>
            <button class="btn btn-outline" onclick="document.getElementById('login-modal').close()">
                Annuler
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
/* Animations */
@keyframes fade-in {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fade-in 0.8s ease-out;
}

/* Product card hover effects */
.product-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.product-card:hover {
    transform: translateY(-8px);
}

/* Line clamp utility */
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Custom scrollbar */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Loading animation */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive grid adjustments */
@media (max-width: 768px) {
    .grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));
    }
}

@media (min-width: 769px) and (max-width: 1024px) {
    .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
}

@media (min-width: 1025px) and (max-width: 1280px) {
    .grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
    }
}

@media (min-width: 1281px) {
    .grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('product-search');
    const searchBtn = document.getElementById('search-btn');
    
    function performSearch() {
        const query = searchInput.value.trim();
        if (query) {
            window.location.href = `?search=${encodeURIComponent(query)}`;
        }
    }
    
    searchBtn.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // Filter functionality
    const categoryFilter = document.getElementById('category-filter');
    const priceFilter = document.getElementById('price-filter');
    const sortFilter = document.getElementById('sort-filter');
    const clearFilters = document.getElementById('clear-filters');
    
    function applyFilters() {
        const params = new URLSearchParams(window.location.search);
        
        if (categoryFilter.value) params.set('category', categoryFilter.value);
        else params.delete('category');
        
        if (priceFilter.value) params.set('price', priceFilter.value);
        else params.delete('price');
        
        if (sortFilter.value) params.set('sort', sortFilter.value);
        else params.delete('sort');
        
        window.location.href = `?${params.toString()}`;
    }
    
    categoryFilter.addEventListener('change', applyFilters);
    priceFilter.addEventListener('change', applyFilters);
    sortFilter.addEventListener('change', applyFilters);
    
    clearFilters.addEventListener('click', function() {
        window.location.href = window.location.pathname;
    });
    
    // Add to cart functionality
    const addToCartButtons = document.querySelectorAll('.add-to-cart');
    addToCartButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            addToCart(productId);
        });
    });
    
    function addToCart(productId) {
        {% if request.user.is_authenticated %}
        fetch('{% url "products:add_to_cart" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]') && document.querySelector('[name=csrfmiddlewaretoken]').value) || '{{ csrf_token }}'
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: 1
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                showNotification('Produit ajouté au panier !', 'success');
                // Update cart count
                updateCartCount();
            } else {
                showNotification(data.message || 'Erreur lors de l\'ajout au panier', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Erreur lors de l\'ajout au panier', 'error');
        });
        {% else %}
        showNotification('Veuillez vous connecter pour ajouter des produits au panier', 'error');
        {% endif %}
    }
    
    function updateCartCount() {
        fetch('{% url "products:cart_count" %}')
        .then(response => response.json())
        .then(data => {
            const cartCountElement = document.querySelector('.cart-count');
            if (cartCountElement && data.cart_count !== undefined) {
                cartCountElement.textContent = data.cart_count;
            }
        })
        .catch(error => {
            console.error('Error updating cart count:', error);
        });
    }
    
    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'error'} fixed top-4 right-4 z-50`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>
            ${message}
        `;
        
        document.body.appendChild(notification);
        
        // Remove notification after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
});
</script>
{% endblock %}
