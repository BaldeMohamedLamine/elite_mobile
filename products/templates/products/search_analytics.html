{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics de Recherche{% endblock %}

{% block extra_css %}
<style>
    .analytics-card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1e40af;
    }
    
    .stat-label {
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    .search-item {
        padding: 0.75rem;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.2s;
    }
    
    .search-item:hover {
        background-color: #f9fafb;
    }
    
    .search-item:last-child {
        border-bottom: none;
    }
    
    .search-query {
        font-weight: 500;
        color: #1f2937;
    }
    
    .search-count {
        color: #6b7280;
        font-size: 0.875rem;
    }
    
    .search-date {
        color: #9ca3af;
        font-size: 0.75rem;
    }
    
    .trend-up {
        color: #10b981;
    }
    
    .trend-down {
        color: #ef4444;
    }
    
    .trend-neutral {
        color: #6b7280;
    }
    
    .chart-container {
        height: 300px;
        position: relative;
    }
    
    .filter-tabs {
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1rem;
    }
    
    .filter-tab {
        padding: 0.75rem 1rem;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .filter-tab.active {
        border-bottom-color: #3b82f6;
        color: #3b82f6;
        font-weight: 500;
    }
    
    .filter-tab:hover {
        background-color: #f9fafb;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Analytics de Recherche</h1>
                    <p class="text-gray-600 mt-1">Statistiques et insights sur les recherches des utilisateurs</p>
                </div>
                
                <div class="flex items-center gap-4">
                    <button onclick="exportData()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>
                        Exporter
                    </button>
                    
                    <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Actualiser
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Statistiques générales -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="analytics-card">
                <div class="stat-number">{{ total_searches|floatformat:0 }}</div>
                <div class="stat-label">Total des recherches</div>
                <div class="flex items-center mt-2">
                    <i class="fas fa-arrow-up text-green-500 mr-1"></i>
                    <span class="text-sm text-green-600">+12% ce mois</span>
                </div>
            </div>
            
            <div class="analytics-card">
                <div class="stat-number">{{ unique_queries|floatformat:0 }}</div>
                <div class="stat-label">Requêtes uniques</div>
                <div class="flex items-center mt-2">
                    <i class="fas fa-arrow-up text-green-500 mr-1"></i>
                    <span class="text-sm text-green-600">+8% ce mois</span>
                </div>
            </div>
            
            <div class="analytics-card">
                <div class="stat-number">{% if total_searches > 0 %}{{ unique_queries|floatformat:0|div:total_searches|floatformat:2 }}{% else %}0{% endif %}</div>
                <div class="stat-label">Taux de diversité</div>
                <div class="flex items-center mt-2">
                    <i class="fas fa-arrow-down text-red-500 mr-1"></i>
                    <span class="text-sm text-red-600">-3% ce mois</span>
                </div>
            </div>
            
            <div class="analytics-card">
                <div class="stat-number">2.3</div>
                <div class="stat-label">Recherches moyennes par session</div>
                <div class="flex items-center mt-2">
                    <i class="fas fa-arrow-up text-green-500 mr-1"></i>
                    <span class="text-sm text-green-600">+5% ce mois</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Recherches populaires -->
            <div class="analytics-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">Recherches Populaires</h2>
                    <span class="text-sm text-gray-500">Top 10</span>
                </div>
                
                <div class="space-y-1">
                    {% for search in popular_searches %}
                    <div class="search-item">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="search-query">{{ search.query }}</div>
                                <div class="search-count">{{ search.search_count }} recherche{{ search.search_count|pluralize }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-gray-900">{{ search.search_count }}</div>
                                <div class="text-xs text-gray-500">fois</div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-search text-3xl mb-2"></i>
                        <p>Aucune donnée de recherche disponible</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Suggestions populaires -->
            <div class="analytics-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">Suggestions Populaires</h2>
                    <span class="text-sm text-gray-500">Top 10</span>
                </div>
                
                <div class="space-y-1">
                    {% for suggestion in popular_suggestions %}
                    <div class="search-item">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="search-query">{{ suggestion.query }}</div>
                                <div class="search-count">Score: {{ suggestion.popularity_score }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-gray-900">{{ suggestion.popularity_score }}</div>
                                <div class="text-xs text-gray-500">points</div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-lightbulb text-3xl mb-2"></i>
                        <p>Aucune suggestion disponible</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Recherches récentes -->
        <div class="analytics-card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Recherches Récentes</h2>
                <div class="flex items-center gap-2">
                    <button onclick="filterRecentSearches('all')" class="filter-tab active" id="tab-all">
                        Toutes
                    </button>
                    <button onclick="filterRecentSearches('today')" class="filter-tab" id="tab-today">
                        Aujourd'hui
                    </button>
                    <button onclick="filterRecentSearches('week')" class="filter-tab" id="tab-week">
                        Cette semaine
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Requête
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Utilisateur
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Résultats
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Date
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for search in recent_searches %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">{{ search.query }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    {% if search.user %}
                                        {{ search.user.username }}
                                    {% else %}
                                        <span class="text-gray-500">Anonyme</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if search.results_count > 10 %}bg-green-100 text-green-800
                                    {% elif search.results_count > 0 %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ search.results_count }} résultat{{ search.results_count|pluralize }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ search.created_at|date:"d/m/Y H:i" }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="viewSearchResults('{{ search.query }}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                    Voir résultats
                                </button>
                                <button onclick="addToSuggestions('{{ search.query }}')" class="text-green-600 hover:text-green-900">
                                    Ajouter aux suggestions
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-search text-3xl mb-2"></i>
                                <p>Aucune recherche récente</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Graphiques et tendances -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Tendance des recherches -->
            <div class="analytics-card">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Tendance des Recherches</h2>
                <div class="chart-container">
                    <canvas id="searchTrendChart"></canvas>
                </div>
            </div>

            <!-- Répartition par catégories -->
            <div class="analytics-card">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Recherches par Catégorie</h2>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Actions d'administration -->
        <div class="analytics-card">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Actions d'Administration</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="clearSearchHistory()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                    <i class="fas fa-trash mr-2"></i>
                    Vider l'historique
                </button>
                
                <button onclick="updateSuggestions()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Mettre à jour les suggestions
                </button>
                
                <button onclick="generateReport()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                    <i class="fas fa-file-pdf mr-2"></i>
                    Générer un rapport
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Variables globales
let searchTrendChart;
let categoryChart;

// Initialisation des graphiques
document.addEventListener('DOMContentLoaded', function() {
    initSearchTrendChart();
    initCategoryChart();
});

// Graphique de tendance des recherches
function initSearchTrendChart() {
    const ctx = document.getElementById('searchTrendChart').getContext('2d');
    
    searchTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
            datasets: [{
                label: 'Recherches',
                data: [12, 19, 3, 5, 2, 3, 8],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Graphique de répartition par catégories
function initCategoryChart() {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    
    categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Électronique', 'Vêtements', 'Maison', 'Sport', 'Autres'],
            datasets: [{
                data: [30, 25, 20, 15, 10],
                backgroundColor: [
                    '#3b82f6',
                    '#10b981',
                    '#f59e0b',
                    '#ef4444',
                    '#8b5cf6'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Filtrage des recherches récentes
function filterRecentSearches(filter) {
    // Mettre à jour les onglets actifs
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.getElementById(`tab-${filter}`).classList.add('active');
    
    // Ici, vous pourriez faire un appel AJAX pour filtrer les données
    console.log(`Filtrage par: ${filter}`);
}

// Voir les résultats d'une recherche
function viewSearchResults(query) {
    window.open(`{% url 'search:search' %}?q=${encodeURIComponent(query)}`, '_blank');
}

// Ajouter aux suggestions
function addToSuggestions(query) {
    if (confirm(`Ajouter "${query}" aux suggestions de recherche ?`)) {
        // Ici, vous pourriez faire un appel AJAX pour ajouter la suggestion
        alert('Suggestion ajoutée avec succès !');
    }
}

// Exporter les données
function exportData() {
    // Ici, vous pourriez générer et télécharger un fichier CSV/Excel
    alert('Export des données en cours...');
}

// Actualiser les données
function refreshData() {
    location.reload();
}

// Vider l'historique de recherche
function clearSearchHistory() {
    if (confirm('Êtes-vous sûr de vouloir vider tout l\'historique de recherche ? Cette action est irréversible.')) {
        // Ici, vous pourriez faire un appel AJAX pour vider l'historique
        alert('Historique vidé avec succès !');
        location.reload();
    }
}

// Mettre à jour les suggestions
function updateSuggestions() {
    if (confirm('Mettre à jour les suggestions de recherche basées sur l\'historique ?')) {
        // Ici, vous pourriez faire un appel AJAX pour mettre à jour les suggestions
        alert('Suggestions mises à jour avec succès !');
        location.reload();
    }
}

// Générer un rapport
function generateReport() {
    // Ici, vous pourriez générer un rapport PDF
    alert('Génération du rapport en cours...');
}
</script>
{% endblock %}
